name: Continuous Integration

on:
  push:
    branches:
      - UAT
      - master

jobs:
  test:
    name: Run Tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --all-features

      - name: Run tests in release mode
        run: cargo test --release --all-features

      - name: Update README test count badge
        if: github.ref == 'refs/heads/master'
        shell: bash
        run: |
          # Count total tests
          TEST_COUNT=$(cargo test -- --list 2>&1 | grep -E '^test ' | wc -l | tr -d ' ')
          echo "Found $TEST_COUNT tests"

          # Update README badge
          sed -i.bak "s/tests-[0-9]\+%20passing/tests-${TEST_COUNT}%20passing/" README.md
          rm -f README.md.bak

          # Check if README was modified
          if git diff --quiet README.md; then
            echo "README test count is already up to date ($TEST_COUNT)"
          else
            echo "Updating README test count to $TEST_COUNT"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add README.md
            git commit -m "Auto-update test count badge to $TEST_COUNT [skip ci]"
            git push origin master
          fi

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test-install-script:
    name: Test Install Script on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test install script syntax
        run: bash -n install.sh

      - name: Test install script execution
        run: |
          export GGO_INSTALL_DIR=/tmp/ggo-ci-test
          bash install.sh

      - name: Verify installation
        run: |
          test -f /tmp/ggo-ci-test/ggo
          /tmp/ggo-ci-test/ggo --version

